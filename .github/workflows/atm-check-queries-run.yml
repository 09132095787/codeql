name: ATM Check Queries Run

env:
  QUERY_PACK: javascript/ql/experimental/adaptivethreatmodeling/src
  QUERY_SUITE: codeql-suites/javascript-atm-code-scanning.qls

on:
  pull_request:
    paths:
      - ".github/workflows/atm-check-queries-run.yml"
      - "javascript/ql/experimental/adaptivethreatmodeling/**"
  workflow_dispatch:

jobs:
  run-atm-queries:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup CodeQL
        uses: ./.github/actions/fetch-codeql
        with:
          channel: release

      - name: Install ATM model
        run: |
          set -exu

          # Install dependencies of ATM query pack, i.e. the ATM model
          codeql pack install "${QUERY_PACK}"

          # Retrieve model checksum
          model_checksum=$(codeql resolve extensions "${QUERY_PACK}/${QUERY_SUITE}" | jq -r '.models[0].checksum')

          # Trust the model so that we can use it in the ATM boosted queries
          mkdir -p "$HOME/.config/codeql"
          echo "--insecurely-execute-ml-model-checksums ${model_checksum}" >> "$HOME/.config/codeql/config"

      - name: Create test DB
        run: |
          DB_PATH="${RUNNER_TEMP}/db"
          codeql database create "${DB_PATH}" --source-root config/atm --language javascript 
          echo "DB_PATH=${DB_PATH}" >> "${GITHUB_ENV}"

      - name: Run ATM query suite
        run: |
          codeql database run-queries -vv -- "${DB_PATH}" "${QUERY_PACK}/${QUERY_SUITE}"
